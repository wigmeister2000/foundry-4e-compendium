{
	"name":"Roll Treasure",
	"type":"script",
	"_id":"zy0jfEqlBT9QpKhH",
	"author":"bBvc0EaHunIoRXDu",
	"img":"icons/svg/chest.svg",
	"scope":"global",
	"command":"const form = \n  `<form>\n    <div class=\"form-group\">\n      <label for=\"level\">Treasure level:</label>\n      <input id=\"level\" type=\"string\" value=1 name=\"inputField\" autofocus>\n    </div>\n    <div class=\"form-group\">\n      <label for=\"d20\">Parcels:</label>\n      <input id=\"d20\" type=\"string\" value=1 name=\"inputField\" autofocus>\n    </div>\n  </form>`;\n  \nasync function createMessage(message) {\n    return ChatMessage.create({\n        user: game.user._id,\n        speaker: game.user.name,\n        content: message\n    });\n}\n\nfunction formatNumber(n){    \n    return new Intl.NumberFormat(\"en-US\",{maximumSignificantDigits: 3}).format(n);\n}\n\nfunction makeLine(result){\n    let line = \"\";\n    switch (true){\n        case result[\"type\"] == \"gold\":\n            line = \"<p><strong>Gold:</strong> \" + formatNumber(result[\"count\"] * result[\"value\"]) + \" gp</p>\";\n            break;\n        case result[\"type\"] == \"gems\":\n            line = \"<p><strong>Gems:</strong> \" + result[\"count\"] + \" gem(s) worth \" + formatNumber(result[\"value\"]) + \" gp</p>\";\n            break;\n        case result[\"type\"] == \"art\":\n            line = \"<p><strong>Art objects:</strong> \" + result[\"count\"] + \" art object(s) worth \" + formatNumber(result[\"value\"]) + \" gp</p>\";\n            break;\n        case result[\"type\"] == \"item\":\n            line = \"<p><strong>Magic item: </strong> \" + result[\"count\"] + \" \" + result[\"rarity\"] + \", level \" + result[\"level\"] + \"</p>\";\n            break;\n    }\n    return line;\n}\n\nasync function rollTreasure(form){\n    const rollOnTreasureTable = game.modules.get(\"dnd-4e-compendium\").api.rollOnTreasureTable;\n    const level = form.find(\"input[id='level']\").val();\n    const n = Number(form.find(\"input[id='d20']\").val());\n    const results = [];\n    const lines = [];\n    let total = 0;\n    \n    for (let i = 0; i < 4; i++){ // Loop over gold, gems, art objects, magic items\n        for (let j = 0; j < n; j++){ // Do all d20 rolls\n            const r = await rollOnTreasureTable(level, i);\n            results.push(r);\n        }\n    }\n\n    for (const r of results){\n        if ([\"gold\", \"gems\", \"art\"].includes(r[\"type\"])){\n            total += r[\"count\"] * r[\"value\"];\n        }\n    }\n\n    for (const r of results.filter(x => [\"gold\", \"gems\", \"art\"].includes(x[\"type\"]))){\n        lines.push(makeLine(r));\n    }\n\n    lines.push(\"<hr><p><b>Total:</b> \" + formatNumber(total) + \" gp</p>\");\n\n    for (const r of results.filter(x => x[\"type\"] == \"item\")){\n        lines.push(makeLine(r));\n    }\n    \n    const msg = \"<p><strong>\" + n + \" Treasure Parcel(s) for Level \" + level + \"</strong></p>\" + lines.join('');\n    \n    createMessage(msg);    \n}\n\nnew Dialog({\n  title: \"Roll Treasure\",\n  content: form,\n  buttons:{\n    apply: {\n      icon: \"<i class='fas fa-dice'></i>\",\n      label: \"Roll\",\n      callback: rollTreasure\n    },\n    close: {\n      icon: \"<i class='fas fa-times'></i>\",\n      label: \"Cancel\",\n      callback: () => {}\n    }\n  },\n  default: \"apply\"\n}).render(true);",
	"folder":null,
	"sort":0,
	"flags":{},
	"_key":"!macros!zy0jfEqlBT9QpKhH"
}